
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div ng-app="app" ng-controller="cont">

    <div class="row">

        <div class="col-sm-12">
            <div class="form-group form-group-sm">
                <button style="box-shadow: 3px 3px 2px #888888" class="btn btn-primary" ng-click="showAddWaitingModal()"><span class="fa fa-plus"></span> Add waiting patient</button>


            </div>

        </div>


 <!-- DISPLAY WAITING LIST -->
    <!-- DISPLAY WAITING LIST -->
       <!-- DISPLAY WAITING LIST -->


        <div class="col-sm-12">

            <div style="box-shadow: 5px 5px 2px #888888" class="panel-primary">
                <div class="panel-heading">Waiting List</div>


                <table st-table="waitingListDisplay" st-safe-src="waitingList" class="table table-condensed table-responsive table-striped table-bordered">
                    <thead>
                        <tr>

                            <th colspan="5"><input st-search="" class="input-sm form-control pull-right" placeholder="Search" type="search" /></th>
                        </tr>
                        <tr>
                            <th></th>
                            <th st-sort="PatientFullName" >Name</th>
                            <th st-sort="Schedule">Schedule</th>
                            <th>Remarks</th>
                            <th></th>
                           
                        </tr>
                    </thead>
                    <tbody>
                        <tr></tr>
                        <tr ng-repeat="row in waitingListDisplay">
                            <td><button class="btn-xs btn btn-success" ng-click="showAdmitModal(row)"><span class="fa fa-arrow-right"></span></button></td>
                            <td>{{row.PatientFullName}}</td>
                            <td>{{row.Schedule | date: 'medium'}}</td>
                            <td>{{row.Remarks}}</td>
                            <td>
                                
                                <button class="btn-xs btn btn-danger" ng-click="showConfirmDeleteModal(row)"><span class="fa fa-remove"></span> Delete</button>
                               

                            </td>
                          
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                          
                            <td class="text-center" st-pagination="" st-items-by-page="10" colspan="4"></td>
                        </tr>
                    </tfoot>
                </table>

            </div>

        </div>


    </div>



<!----------------------------------------------->
    <!----------------------------------------------->
        <!----------------------------------------------->


  <!-- ADD WAITING LIST -->
        <!-- ADD WAITING LIST -->
            <!-- ADD WAITING LIST -->


    <div class="modal fade" id="addModal" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Patients</h4>
                </div>
                <div class="modal-body">
                                       
                        <table st-table="patientsListDisplay" st-safe-src="patientsList" class="table table-condensed table-responsive table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th colspan="5"><input st-search=""  class="input-sm form-control pull-right" placeholder="Search" type="search" /></th>
                                </tr>
                                <tr>
                                    
                                    <th>Name</th>
                                    <th>Gender</th>
                                    <th>Birth Date</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr></tr>
                                <tr ng-repeat="row in patientsListDisplay">
                                    <td>{{row.FirstName + ' ' + row.MiddleName + " " + row.LastName}}</td>
                                    <td>{{row.Gender}}</td>
                                    <td>{{row.BirthDate | date: 'MMM dd, yyyy'}}</td>
                                    <td>
                                        <button class="btn-xs btn btn-primary" ng-click="addWaiting(row.Id)"><span class="fa fa-plus"></span> Add</button>

                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>

                                    <td class="text-center" st-pagination="" st-items-by-page="10" colspan="4"></td>
                                </tr>
                            </tfoot>
                        </table>
                  
                    <hr />
                  
                    <input id="remarksTb" class="input-sm form-control" placeholder="Remarks" />

                    </div>
               
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title"><span class="fa fa-question"></span> Confirm</h4>
                </div>
                <div class="modal-body">
                    <h4>Are you sure you want to remove <span><strong id="dName"></strong></span> from waiting list?</h4>
                  

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sm btn btn-primary" data-dismiss="modal">No</button>
                    <button type="button" class="btn-sm btn btn-primary" ng-click="DeleteWaiting()" data-dismiss="modal">  Yes  </button>
                    
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
       
   
    <div class="modal fade" id="admitModal" tabindex="-1" role="dialog" aria-labelledby="admitModal-label" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="admitModal-label"><span class="fa fa-question"></span> Confirm</h4>
                </div>
                <div class="modal-body">
                  <h4>Admit patient <strong id="confirmAdmitPatientName"></strong>?</h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Admit</button>
                </div>
            </div>
        </div>
    </div>


</div>


@section Scripts{


    <script src="~/.bin/bower_components/angular-smart-table/dist/smart-table.min.js"></script>

    <script>

        angular.module('app', ['smart-table'], function () { })
        .controller('cont', function ($scope, $http) {


            function ToJavaScriptDate(value) {
                var pattern = /Date\(([^)]+)\)/;
                var results = pattern.exec(value);
                var dt = new Date(parseFloat(results[1]));
                return dt;
            }

            //GET WAITINGLIST

            $scope.waitingList = [];
            $scope.waitingListDisplay = [].concat($scope.waitingList);

            $http({
                method: 'GET',
                url: '/Waiting/getWaitingPatients'
            }).success(function (data) {

                angular.forEach(data, function (resdata) {


                    var Schedule = new Date(ToJavaScriptDate(resdata.Schedule))
                    resdata.Schedule = Schedule;
                 

                });


                $scope.waitingList = data;

            }, function errorCallback(data) {

            });


            //ADD WAITING PATIENT

            $scope.patientsList = [];
            $scope.patientsListDisplay = [].concat($scope.patientsList);

            $scope.showAddWaitingModal = function () {

                $('#addModal').modal('toggle');

                $http({
                    method: 'GET',
                    url: '/Patients/getPatients'
                }).success(function (data) {

                    angular.forEach(data, function (resdata) {


                        var BirthDate = new Date(ToJavaScriptDate(resdata.BirthDate))
                        resdata.BirthDate = BirthDate;


                    });

                    $scope.patientsList = data;

                }, function errorCallback(data) {

                });

            }


            $scope.addWaiting = function (Id) {

                $scope.waitingModel = {
                    'Id': '',
                    'PatientId': Id,
                    'Schedule': '',
                    'Remarks': $('#remarksTb').val()

                };

                $http({
                    method: 'POST',
                    url: '/Waiting/addWaitingPatient',
                    data: $.param({ patient: $scope.waitingModel }),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).success(function (data) {

                  

                        var Schedule = new Date(ToJavaScriptDate(data.Schedule))
                        data.Schedule = Schedule;
                    
                    $scope.waitingList.push(data);

                    $('#addModal').modal('toggle');
                });

            };


            //DELETE WAITING PATIENTS


            $scope.selectedWaitingRow;

            $scope.showConfirmDeleteModal = function (row) {

                $scope.selectedWaitingRow = row;

                $('#deleteModal').modal('toggle');

                $('#dName').text(row.PatientFullName);


            }

            $scope.DeleteWaiting = function () {

                
                $http({
                    method: 'GET',
                    url: '/Waiting/deleteWaitingPatient?id='+ $scope.selectedWaitingRow.Id +''
                }).success(function (data) {

                    if (data == "ok") {

                        var index = $scope.waitingList.indexOf($scope.selectedWaitingRow);

                        $scope.waitingList.splice(index, 1);
                    }

                }, function errorCallback(data) {

                });


            };



            $scope.showAdmitModal = function (row) {

                $scope.selectedWaitingRow = row;

                $('#admitModal').modal('toggle');

                $('#confirmAdmitPatientName').text(row.PatientFullName);

            }

            $scope.admitPatient = function () {


            }


        });

    </script>


}